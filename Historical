// historical-map.js - ОТЛАДОЧНАЯ ВЕРСИЯ
console.log("historical-map.js загружен");

class HistoricalPollutionMap {
    constructor() {
        console.log("Конструктор HistoricalPollutionMap вызван");
        this.currentYear = 2024;
        this.currentDataType = 'air';
        this.currentMarkers = [];
        this.initMap();
    }

    initMap() {
        console.log("initMap() вызван");
        
        const mapContainer = document.getElementById('pollutionMap');
        console.log("Контейнер карты:", mapContainer);
        
        if (!mapContainer) {
            console.error('❌ Контейнер карты pollutionMap не найден!');
            this.showDebugInfo('❌ Контейнер карты не найден');
            return;
        }

        try {
            console.log("Попытка создать карту Leaflet...");
            
            // Проверяем, доступен ли Leaflet
            if (typeof L === 'undefined') {
                console.error('❌ Leaflet не загружен');
                this.showDebugInfo('❌ Leaflet не загружен');
                return;
            }
            
            console.log("Leaflet доступен:", L);
            
            // Создаем карту
            this.map = L.map('pollutionMap').setView([55.7558, 37.6173], 3);
            console.log("Карта создана:", this.map);
            
            // Добавляем слой карты
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(this.map);
            
            console.log("✅ Карта успешно инициализирована");
            this.showDebugInfo('✅ Карта создана');
            
            // Добавляем тестовый маркер
            L.marker([55.7558, 37.6173])
                .addTo(this.map)
                .bindPopup('Тестовый маркер - Москва')
                .openPopup();
                
            this.setupEventListeners();
            
        } catch (error) {
            console.error('❌ Ошибка инициализации карты:', error);
            this.showDebugInfo('❌ Ошибка: ' + error.message);
        }
    }

    setupEventListeners() {
        console.log("setupEventListeners() вызван");
        
        // Слайдер года
        const yearSlider = document.getElementById('yearSlider');
        const yearDisplay = document.getElementById('currentYearDisplay');
        
        console.log("Слайдер:", yearSlider, "Дисплей:", yearDisplay);
        
        if (yearSlider && yearDisplay) {
            yearSlider.addEventListener('input', (e) => {
                this.currentYear = parseInt(e.target.value);
                yearDisplay.textContent = this.currentYear;
                console.log("Год изменен на:", this.currentYear);
            });
        }

        // Кнопки типа данных
        const dataButtons = document.querySelectorAll('.data-btn');
        console.log("Найдено кнопок:", dataButtons.length);
        
        dataButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                console.log("Кнопка нажата:", e.target.dataset.type);
                dataButtons.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentDataType = e.target.dataset.type;
                console.log("Тип данных изменен на:", this.currentDataType);
            });
        });
    }

    showDebugInfo(message) {
        const debugDiv = document.getElementById('debugInfo');
        if (debugDiv) {
            debugDiv.innerHTML = message + ' - ' + new Date().toLocaleTimeString();
        }
        console.log("DEBUG:", message);
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log("✅ DOM полностью загружен");
    
    const debugDiv = document.getElementById('debugInfo');
    if (debugDiv) {
        debugDiv.innerHTML = 'DOM загружен - инициализация карты...';
    }
    
    // Проверяем, существует ли элемент карты
    const mapContainer = document.getElementById('pollutionMap');
    console.log("Контейнер карты при DOMContentLoaded:", mapContainer);
    
    if (mapContainer) {
        console.log("✅ Контейнер карты найден, создаем карту...");
        try {
            window.historicalMap = new HistoricalPollutionMap();
        } catch (error) {
            console.error('❌ Ошибка при создании исторической карты:', error);
            if (debugDiv) {
                debugDiv.innerHTML = '❌ Ошибка создания карты: ' + error.message;
            }
        }
    } else {
        console.error('❌ Контейнер карты pollutionMap не найден в DOM');
        if (debugDiv) {
            debugDiv.innerHTML = '❌ Контейнер карты не найден';
        }
    }
});

// Также проверяем, когда все ресурсы загружены
window.addEventListener('load', function() {
    console.log("✅ Все ресурсы страницы загружены");
    const debugDiv = document.getElementById('debugInfo');
    if (debugDiv) {
        debugDiv.innerHTML += '<br>Все ресурсы загружены';
    }
});
